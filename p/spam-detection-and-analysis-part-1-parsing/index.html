<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Spam is still a common attack method. Most of the email services have spam filters that can help us block and filter out most of the emails with commercial, fraudulent and malicious content. The purpose of the project is to explore and analyze the email header to identify the features that can tell us which emails are malicious."><title>Spam Detection and Analysis (Part 1 - Parsing)</title><link rel=canonical href=https://lijohnny.com/p/spam-detection-and-analysis-part-1-parsing/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="Spam Detection and Analysis (Part 1 - Parsing)"><meta property="og:description" content="Spam is still a common attack method. Most of the email services have spam filters that can help us block and filter out most of the emails with commercial, fraudulent and malicious content. The purpose of the project is to explore and analyze the email header to identify the features that can tell us which emails are malicious."><meta property="og:url" content="https://lijohnny.com/p/spam-detection-and-analysis-part-1-parsing/"><meta property="og:site_name" content="Johnny's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Python"><meta property="article:tag" content="R"><meta property="article:tag" content="Regression"><meta property="article:tag" content="Analysis"><meta property="article:tag" content="Parsing"><meta property="article:tag" content="BeautifulSoup,"><meta property="article:tag" content="Spam"><meta property="article:tag" content="Email"><meta property="article:tag" content="HTML"><meta property="article:published_time" content="2019-04-19T01:24:59+00:00"><meta property="article:modified_time" content="2019-04-19T01:24:59+00:00"><meta property="og:image" content="https://i.loli.net/2019/05/10/5cd50420b955f.png"><meta name=twitter:site content="IAmJohnnyLi"><meta name=twitter:title content="Spam Detection and Analysis (Part 1 - Parsing)"><meta name=twitter:description content="Spam is still a common attack method. Most of the email services have spam filters that can help us block and filter out most of the emails with commercial, fraudulent and malicious content. The purpose of the project is to explore and analyze the email header to identify the features that can tell us which emails are malicious."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://i.loli.net/2019/05/10/5cd50420b955f.png"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-136585559-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta name=keywords content="Python,R,Regression,detection,analysis, parsing, BeautifulSoup, spam, email"></head><body><script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.body.dataset.scheme='dark':document.body.dataset.scheme='light'})()</script><div class="container main-container flex on-phone--column extended article-page with-toolbar"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/img/wechatjohnny_hu8fd990fde31e9d807c195376b9ec1613_42994_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>üññ</span></figure><h1 class=site-name><a href=https://lijohnny.com>Johnny's Blog</a></h1><h2 class=site-description>Data Scientist | Program Manager</h2></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></ol></aside><main class="main full-width"><div id=article-toolbar><a href=https://lijohnny.com class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/spam-detection-and-analysis-part-1-parsing/><img src=https://i.loli.net/2019/05/10/5cd50420b955f.png loading=lazy alt="Featured image of post Spam Detection and Analysis (Part 1 - Parsing)"></a></div><div class=article-details><header class=article-category><a href=/categories/data/ style=background-color:#2a9d8f;color:#fff>Data</a>
<a href=/categories/python/ style=background-color:#2a9d8f;color:#fff>Python</a></header><h2 class=article-title><a href=/p/spam-detection-and-analysis-part-1-parsing/>Spam Detection and Analysis (Part 1 - Parsing)</a></h2><h3 class=article-subtitle>Spam is still a common attack method. Most of the email services have spam filters that can help us block and filter out most of the emails with commercial, fraudulent and malicious content. The purpose of the project is to explore and analyze the email header to identify the features that can tell us which emails are malicious.</h3><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Apr 19, 2019</time></footer></div></header><section class=article-content><p>Spam is still a common attack method. Most of the email services have spam filters that can help us block and filter out most of the emails with commercial, fraudulent and malicious content. The purpose of the project is to explore and analyze the email header to identify the features that can tell us which emails are malicious.</p><h2 id=get-email-header-information>Get Email Header information</h2><p>First thing we need to do is the get the data. Email Header contents a lots of information that usually a email client do not show that to the users. However, most of those informations reveal more information about the sender. Therefore, we need to get Email Headers and parsing them for analysis.
I use Python&rsquo;s <code>imaplib</code> library to get email headers from my Gmail account Spam folder.</p><blockquote><p>For the script to work, Gmail IMAP Access need to be enabled. To enable IMAP for Gmail, please check this <a class=link href=https://support.google.com/mail/answer/7126229 target=_blank rel=noopener>instruction</a>. You also need to either turn off 2-Step Verification for your Google account or set up an app password <a class=link href=https://myaccount.google.com/u/1/security target=_blank rel=noopener>here</a>.</p></blockquote><h3 id=setup-connection>Setup connection</h3><ol><li>Import the required libraries.</li></ol><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>getpass</span>
<span class=kn>import</span> <span class=nn>imaplib</span>
<span class=kn>import</span> <span class=nn>email</span>
<span class=kn>from</span> <span class=nn>email.parser</span> <span class=kn>import</span> <span class=n>HeaderParser</span>
<span class=kn>from</span> <span class=nn>email.header</span> <span class=kn>import</span> <span class=n>decode_header</span>
<span class=kn>import</span> <span class=nn>re</span>
<span class=kn>import</span> <span class=nn>csv</span>
<span class=kn>import</span> <span class=nn>pandas</span> <span class=kn>as</span> <span class=nn>pd</span>
<span class=kn>from</span> <span class=nn>bs4</span> <span class=kn>import</span> <span class=n>BeautifulSoup</span>
<span class=kn>import</span> <span class=nn>requests</span>
<span class=kn>import</span> <span class=nn>json</span>
</code></pre></div><ol start=2><li>Login to the Gmail</li></ol><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>print</span><span class=p>(</span><span class=s1>&#39;Email:&#39;</span><span class=p>)</span>
<span class=n>un</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
<span class=k>print</span><span class=p>(</span><span class=s1>&#39;Password&#39;</span><span class=p>)</span>
<span class=n>pw</span> <span class=o>=</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getpass</span><span class=p>()</span> <span class=c1># hide passowrad with getpass() function.</span>
<span class=n>conn</span> <span class=o>=</span> <span class=n>imaplib</span><span class=o>.</span><span class=n>IMAP4_SSL</span><span class=p>(</span><span class=n>port</span> <span class=o>=</span> <span class=s1>&#39;993&#39;</span><span class=p>,</span><span class=n>host</span> <span class=o>=</span> <span class=s1>&#39;imap.gmail.com&#39;</span><span class=p>)</span>
<span class=n>conn</span><span class=o>.</span><span class=n>login</span><span class=p>(</span><span class=n>un</span><span class=p>,</span><span class=n>pw</span><span class=p>)</span>
</code></pre></div><h3 id=download-email-and-parsing-email-header>Download Email and Parsing Email Header</h3><ol><li>Get email list.</li></ol><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>conn</span><span class=o>.</span><span class=n>select</span><span class=p>(</span><span class=s1>&#39;[Gmail]/Spam&#39;</span><span class=p>)</span> <span class=c1># Get email form spam folder.</span>
<span class=nb>type</span><span class=p>,</span> <span class=n>emaildata</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=bp>None</span><span class=p>,</span> <span class=s1>&#39;ALL&#39;</span><span class=p>)</span>
<span class=n>emaillist</span><span class=o>=</span><span class=n>emaildata</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>()</span> <span class=c1># Get email list.</span>
<span class=n>parser</span> <span class=o>=</span> <span class=n>HeaderParser</span><span class=p>()</span>
<span class=n>header_list</span><span class=o>=</span><span class=p>[]</span>
<span class=n>msg_text</span><span class=o>=</span><span class=p>[]</span>

<span class=c1># Read API key for ipstack.com from key.txt file.</span>
<span class=n>key_f</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;key.txt&#34;</span><span class=p>,</span><span class=s2>&#34;r&#34;</span><span class=p>)</span>
<span class=n>key</span><span class=o>=</span><span class=n>key_f</span><span class=o>.</span><span class=n>readlines</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span>
</code></pre></div><ol start=2><li>Parsing email</li></ol><p>Usually an email header looks like this:
What we want are:</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>Subject</code></td><td>The Subject of Email</td></tr><tr><td><code>Reply-To</code></td><td>The reply address that when you click reply button in you Email client</td></tr><tr><td><code>Return-Path</code></td><td>The reply address that when you click reply button in you Email client</td></tr><tr><td><code>IP</code></td><td>The sender&rsquo;s IP address</td></tr><tr><td><code>Received Time</code></td><td>When is the email received</td></tr><tr><td><code>From</code></td><td>The senders&rsquo;s address</td></tr><tr><td><code>Date</code></td><td>The date the message was sent</td></tr><tr><td><code>Content-Type</code></td><td>Indicated what contents in the email</td></tr><tr><td><code>Message</code></td><td>The email content</td></tr><tr><td><code>DMARC</code></td><td>Domain-Based Message Authentication Reporting and Conformance</td></tr><tr><td><code>DKIM</code></td><td>Domain Keys Identified Mail</td></tr><tr><td><code>ARC-Authentication-Results</code></td><td>Authenticated Received Chain</td></tr><tr><td><code>SPF</code></td><td>Sender Policy Framework</td></tr></tbody></table><p>Now we need to parse each email in the emaillist by using for loop.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>emaillist</span><span class=p>:</span>
    <span class=nb>type</span><span class=p>,</span> <span class=n>emaildata2</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=s1>&#39;(RFC822)&#39;</span><span class=p>)</span>
    <span class=n>h</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parsestr</span><span class=p>(</span><span class=n>emaildata2</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span><span class=s1>&#39;ignore&#39;</span><span class=p>))</span>
</code></pre></div><p>Some emails have an html format message. The html tags are not helping us in this project. Therefore, we can use <code>BeautifulSoup</code> to get text from the email message.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python>    <span class=k>for</span> <span class=n>txt</span> <span class=ow>in</span> <span class=n>h</span><span class=o>.</span><span class=n>walk</span><span class=p>():</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>txt</span><span class=o>.</span><span class=n>is_multipart</span><span class=p>():</span>
            <span class=n>msg_text</span> <span class=o>=</span> <span class=n>txt</span><span class=o>.</span><span class=n>get_payload</span><span class=p>(</span><span class=n>decode</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>,</span><span class=s1>&#39;ignore&#39;</span><span class=p>)</span>
    <span class=n>soup</span> <span class=o>=</span> <span class=n>BeautifulSoup</span><span class=p>(</span><span class=n>msg_text</span><span class=p>,</span> <span class=s2>&#34;lxml&#34;</span><span class=p>)</span>
    <span class=n>msg_text</span><span class=o>=</span> <span class=n>soup</span><span class=o>.</span><span class=n>get_text</span><span class=p>(</span><span class=n>strip</span><span class=o>=</span><span class=bp>True</span><span class=p>)</span>
</code></pre></div><p>Most information is clear and do not need clean and edit.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python>    <span class=n>header</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Subject&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>decode_header</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Subject&#39;</span><span class=p>])[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;ARC-Authentication-Results&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;ARC-Authentication-Results&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Return-Path&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Return-Path&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Return-Path Address&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\b@\S*\b&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Return-Path&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()))[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Received&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Received&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Received-SPF&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Received-SPF&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Date&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Date&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
    <span class=k>if</span> <span class=s1>&#39;Reply-To&#39;</span> <span class=ow>in</span> <span class=n>h</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Reply-To&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Reply-To&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Reply-To Address&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\b@\S*\b&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Reply-To&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()))[</span><span class=mi>0</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Reply-To&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Reply-To Address&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;;&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;From&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;From&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</code></pre></div><p>However, for the data contents many irrelevant information and need to be cleaned. I use Regular expression operations to extract only useful information.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python>    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\b@\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;From&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>())):</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;From Address&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\b@\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;From&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()))[</span><span class=mi>0</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;From Address&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
    <span class=c1>#header[&#39;Sender-ip&#39;]= re.findall(r&#39;(?:(?:25[0-5]|2[0-4]\d|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)&#39;,str(header))</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Message&#39;</span><span class=p>]</span><span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg_text</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bip=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>)):</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;IP&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bip=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;IP&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bspf=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>)):</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;SPF&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bspf=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;SPF&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bdmarc=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>)):</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;DMARC&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bdmarc=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;DMARC&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
    <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bdkim=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>)):</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;DKIM&#39;</span><span class=p>]</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\bdkim=\S*\b&#39;</span><span class=p>,</span><span class=nb>str</span><span class=p>(</span><span class=n>header</span><span class=p>))[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;DKIM&#39;</span><span class=p>]</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</code></pre></div><p>I use the api of ipstack.com to convert IP to geographic location.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python>    <span class=n>address</span> <span class=o>=</span> <span class=s2>&#34;http://api.ipstack.com/&#34;</span><span class=o>+</span><span class=n>header</span><span class=p>[</span><span class=s1>&#39;IP&#39;</span><span class=p>]</span><span class=o>+</span><span class=s2>&#34;?access_key=&#34;</span><span class=o>+</span><span class=n>key</span>    
    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>address</span><span class=p>)</span>
    <span class=n>ipjason</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span>
    <span class=n>iplist</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>ipjason</span><span class=p>)</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Country&#39;</span><span class=p>]</span><span class=o>=</span> <span class=n>iplist</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;country_name&#39;</span><span class=p>)</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;Regin&#39;</span><span class=p>]</span><span class=o>=</span> <span class=n>iplist</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;region_name&#39;</span><span class=p>)</span>
    <span class=n>header</span><span class=p>[</span><span class=s1>&#39;City&#39;</span><span class=p>]</span><span class=o>=</span> <span class=n>iplist</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;city&#39;</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>iplist</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span><span class=o>==</span> <span class=s1>&#39;ipv6&#39;</span> <span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;IPv6 Indicator&#39;</span><span class=p>]</span><span class=o>=</span> <span class=mi>1</span>
    <span class=k>elif</span> <span class=n>iplist</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span><span class=o>==</span> <span class=s1>&#39;ipv4&#39;</span> <span class=p>:</span>
        <span class=n>header</span><span class=p>[</span><span class=s1>&#39;IPv6 Indicator&#39;</span><span class=p>]</span><span class=o>=</span> <span class=mi>0</span>
    <span class=n>header_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>header</span><span class=p>)</span>

    <span class=c1># For Loop END</span>
</code></pre></div><p>For consistent analysis, I save the DataFrame into a CSV file for further analysis.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>keys</span> <span class=o>=</span> <span class=n>header_list</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
<span class=k>print</span><span class=p>(</span><span class=s1>&#39;File Name:&#39;</span><span class=p>)</span>
<span class=n>fn</span> <span class=o>=</span> <span class=nb>input</span><span class=p>()</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>fn</span><span class=o>+</span><span class=s1>&#39;.csv&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>output_file</span><span class=p>:</span>
    <span class=n>dict_writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>DictWriter</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=n>keys</span><span class=p>)</span>
    <span class=n>dict_writer</span><span class=o>.</span><span class=n>writeheader</span><span class=p>()</span>
    <span class=n>dict_writer</span><span class=o>.</span><span class=n>writerows</span><span class=p>(</span><span class=n>header_list</span><span class=p>)</span>
</code></pre></div><blockquote><p>This is the Part 1 of the series. For how to user R analysis the email, please check <a class=link href=/p/spam-detection-and-analysis-part-2-analysis-with-r/>Part 2</a></p></blockquote></section><footer class=article-footer><section class=article-tags><a href=/tags/python/>Python</a>
<a href=/tags/r/>R</a>
<a href=/tags/regression/>Regression</a>
<a href=/tags/analysis/>Analysis</a>
<a href=/tags/parsing/>Parsing</a>
<a href=/tags/beautifulsoup/>BeautifulSoup,</a>
<a href=/tags/spam/>Spam</a>
<a href=/tags/email/>Email</a>
<a href=/tags/html/>HTML</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0 Êú¨ÊñáÂÜÖÂÆπÂü∫‰∫éCC BY-NC-SA 4.0ÂçèËÆÆÂèëÂ∏ÉÔºåËΩ¨ËΩΩÈúÄË¶ÅÁΩ≤Âêç„ÄÇ</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/spam-detection-and-analysis-part-2-analysis-with-r/><div class=article-image><img src=https://i.loli.net/2019/05/10/5cd5051a0e1f9.png loading=lazy data-key data-hash=https://i.loli.net/2019/05/10/5cd5051a0e1f9.png></div><div class=article-details><h2 class=article-title>Spam Detection and Analysis (Part 2 - Analysis with R)</h2></div></a></article><article class=has-image><a href=/p/craigslist-vacation-house-data-crawling/><div class=article-image><img src=https://i.loli.net/2019/05/12/5cd7d789264a1.jpg loading=lazy data-key data-hash=https://i.loli.net/2019/05/12/5cd7d789264a1.jpg></div><div class=article-details><h2 class=article-title>Craigslist Vacation House Data Crawling</h2></div></a></article><article class=has-image><a href=/p/price-strategy-based-on-features-reputation/><div class=article-image><img src=https://i.loli.net/2021/03/15/4BxDCOzgPulU89Y.jpg loading=lazy data-key data-hash=https://i.loli.net/2021/03/15/4BxDCOzgPulU89Y.jpg></div><div class=article-details><h2 class=article-title>Price Strategy Based on Features Reputation</h2></div></a></article><article class=has-image><a href=/p/identify-customer-segments/><div class=article-image><img src=https://i.loli.net/2021/03/13/7dfc3OoaYZAnejX.jpg loading=lazy data-key data-hash=https://i.loli.net/2021/03/13/7dfc3OoaYZAnejX.jpg></div><div class=article-details><h2 class=article-title>Identify Customer Segments</h2></div></a></article><article class=has-image><a href=/p/donors-identification-for-charityml/><div class=article-image><img src=https://i.loli.net/2019/05/30/5cef9192b167778174.jpg loading=lazy data-key data-hash=https://i.loli.net/2019/05/30/5cef9192b167778174.jpg></div><div class=article-details><h2 class=article-title>Donors Identification for CharityML</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//lijohnny.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2019 -
2021 Johnny's Blog</section><section class=powerby>All contents licensed under CC BY-NC-SA 4.0 Êú¨Á´ôÊâÄÊúâÂÜÖÂÆπÂü∫‰∫éCC BY-NC-SA 4.0ÂçèËÆÆÂèëÂ∏ÉÔºåËΩ¨ËΩΩÈúÄË¶ÅÁΩ≤Âêç<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script></body></html>